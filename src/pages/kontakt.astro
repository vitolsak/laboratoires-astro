---
import Layout from '../layouts/Layout.astro';
import { Resend } from 'resend';

// Získáme veřejný klíč pro reCAPTCHA pro použití v klientovi
const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;

// Serverová logika pro zpracování formuláře
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const name = formData.get('name')?.toString() || 'Nezadáno';
    const email = formData.get('email')?.toString() || 'Nezadán';
    const message = formData.get('message')?.toString() || 'Bez textu';
    const token = formData.get('g-recaptcha-response')?.toString();

    // 1. Ověření reCAPTCHA tokenu
    if (!token) {
      throw new Error("Chybí reCAPTCHA token.");
    }
    
    const recaptchaUrl = 'https://www.google.com/recaptcha/api/siteverify';
    const recaptchaResponse = await fetch(recaptchaUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `secret=${import.meta.env.RECAPTCHA_SECRET_KEY}&response=${token}`,
    });
    const recaptchaData = await recaptchaResponse.json();

    // 2. Kontrola skóre (0.5 je běžný práh)
    if (!recaptchaData.success || recaptchaData.score < 0.5) {
      console.error("reCAPTCHA verification failed:", recaptchaData['error-codes']);
      // Pro uživatele to můžeme zobrazit jako obecnou chybu
      return new Response("Ověření proti spamu selhalo. Zkuste to prosím znovu.", { status: 400 });
    }

    // 3. Pokud je to člověk, odešleme e-mail
    const resend = new Resend(import.meta.env.RESEND_API_KEY);
    await resend.emails.send({
        from: 'Kontaktni Formular <formular@evermo.cz>', // E-mail, který jste ověřili u Resend
        to: import.meta.env.RECIPIENT_EMAIL,
        subject: `Dotaz z webu Evermo.cz - ${name}`,
        reply_to: email,
        html: `<p><strong>Jméno:</strong> ${name}</p><p><strong>Email:</strong> ${email}</p><p><strong>Zpráva:</strong></p><p>${message}</p>`,
    });

    // Přesměrujeme na děkovací stránku
    return Astro.redirect('/dekujeme'); 

  } catch (error) {
    console.error(error);
    return new Response("Odeslání selhalo, nastala interní chyba.", { status: 500 });
  }
}
---

<Layout title="Kontakt | Laboratoires.cz">
    <section class="py-16 md:py-24 bg-white">
        <div class="container mx-auto px-6">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-serif text-brand-primary mb-2">Kontaktujte nás</h2>
                <p class="text-lg text-gray-600">Máte dotaz? Rádi vám poradíme.</p>
            </div>
            <div class="max-w-4xl mx-auto flex flex-col md:flex-row gap-12">
                <div class="md:w-1/2">
                    <h3 class="text-2xl font-serif text-brand-primary mb-4">Spojte se s námi</h3>
                    <div class="space-y-4 text-gray-700">
                        <div class="flex items-start gap-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-brand-accent mt-1 h-5 w-5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                            <div>
                                <h4 class="font-bold">Telefon</h4>
                                <a href="tel:+420608777144" class="hover:text-brand-primary">+420 608 777 144</a>
                            </div>
                        </div>
                        <div class="flex items-start gap-4">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-brand-accent mt-1 h-5 w-5"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                            <div>
                                <h4 class="font-bold">E-mail</h4>
                                <a href="mailto:info@lofn.cz" class="hover:text-brand-primary">info@lofn.cz</a>
                            </div>
                        </div>
                         <div class="flex items-start gap-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-brand-accent mt-1 h-5 w-5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <div>
                                <h4 class="font-bold">Fakturační údaje</h4>
                                <p>P&A Thrax s.r.o.<br>IČ: 28657985<br>Holubova 1204/27, 703 00 Ostrava</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="md:w-1/2 bg-brand-secondary p-8 rounded-lg shadow-sm">
                    <form action="/kontakt" method="POST">
                        <div class="mb-4">
                            <label for="name" class="block text-brand-text mb-1 font-medium">Jméno</label>
                            <input type="text" id="name" name="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-brand-accent focus:border-brand-accent" required>
                        </div>
                        <div class="mb-4">
                            <label for="email" class="block text-brand-text mb-1 font-medium">E-mail</label>
                            <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-brand-accent focus:border-brand-accent" required>
                        </div>
                        <div class="mb-6">
                            <label for="message" class="block text-brand-text mb-1 font-medium">Vaše zpráva</label>
                            <textarea id="message" name="message" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-brand-accent focus:border-brand-accent" required></textarea>
                        </div>
                        
                        <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response">

                        <button type="submit" class="w-full bg-brand-primary hover:bg-brand-text text-white font-bold py-3 px-6 rounded-full transition-colors">Odeslat zprávu</button>
                    </form>
                    <div id="form-feedback" class="mt-4 text-center"></div>
                </div>
            </div>
        </div>
    </section>
</Layout>

<script define:vars={{ recaptchaSiteKey }}>
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            
            grecaptcha.ready(function() {
                grecaptcha.execute(recaptchaSiteKey, {action: 'submit'}).then(function(token) {
                    document.getElementById('g-recaptcha-response').value = token;
                    e.target.submit();
                });
            });
        });
    }
</script>
<script is:inline src={`https://www.google.com/recaptcha/api.js?render=${recaptchaSiteKey}`}></script>