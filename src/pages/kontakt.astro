---
import Layout from '../layouts/Layout.astro';
import { Resend } from 'resend';

const recaptchaSiteKey = import.meta.env.PUBLIC_RECAPTCHA_SITE_KEY;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const name = formData.get('name');
    const email = formData.get('email');
    const message = formData.get('message');
    const token = formData.get('g-recaptcha-response');

    // 1. Ověření reCAPTCHA tokenu
    const recaptchaUrl = 'https://www.google.com/recaptcha/api/siteverify';
    const recaptchaResponse = await fetch(recaptchaUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `secret=${import.meta.env.RECAPTCHA_SECRET_KEY}&response=${token}`,
    });
    const recaptchaData = await recaptchaResponse.json();

    // 2. Kontrola skóre (0.5 je běžný práh)
    if (!recaptchaData.success || recaptchaData.score < 0.5) {
      // Pokud je to robot, tiše selžeme nebo přesměrujeme na chybovou stránku
      return new Response("Ověření selhalo", { status: 400 });
    }

    // 3. Pokud je to člověk, odešleme e-mail
    const resend = new Resend(import.meta.env.RESEND_API_KEY);
    await resend.emails.send({
        from: 'Kontaktni Formular <formular@evermo.cz>',
        to: import.meta.env.RECIPIENT_EMAIL,
        subject: `Dotaz z webu Evermo.cz - ${name}`,
        reply_to: email,
        html: `<p>Jméno: ${name}</p><p>Email: ${email}</p><p>Zpráva: ${message}</p>`,
    });

    return Astro.redirect('/dekujeme');

  } catch (error) {
    console.error(error);
    return new Response("Odeslání selhalo", { status: 500 });
  }
}
---
<Layout title="Kontakt | Laboratoires.cz">
    <form action="/kontakt" method="POST">
        <input type="hidden" id="g-recaptcha-response" name="g-recaptcha-response">
        
        <button type="submit" class="w-full ...">Odeslat zprávu</button>
    </form>
    <script define:vars={{ recaptchaSiteKey }}>
        // Tato funkce se spustí, když uživatel klikne na "Odeslat"
        document.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault(); // Zastavíme odeslání formuláře
            
            grecaptcha.ready(function() {
                grecaptcha.execute(recaptchaSiteKey, {action: 'submit'}).then(function(token) {
                    // Vložíme token do skrytého políčka
                    document.getElementById('g-recaptcha-response').value = token;
                    // Nyní formulář odešleme
                    e.target.submit();
                });
            });
        });
    </script>
    <script src="https://www.google.com/recaptcha/api.js?render={recaptchaSiteKey}" async defer></script>
</Layout>